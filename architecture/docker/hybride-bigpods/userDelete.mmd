sequenceDiagram
    autonumber
    actor User
    participant WebClient as Web Client
    participant Gateway as Gateway :4000
    participant CoreNginx as Core NGINX :80
    participant UserService as User Service :3002
    participant Auth as Auth Service :3001
    participant Redis as Redis :6379
    participant DB as PostgreSQL
    participant Kafka as Kafka Events
    participant FileSystem as Local FileSystem

    User->>WebClient: Navigate to "Settings"<br/>Click "Delete Account"
    
    WebClient->>WebClient: Show confirmation dialog:<br/>"Are you sure? This action cannot be undone!"
    
    User->>WebClient: Confirm deletion
    
    WebClient->>Gateway: DELETE /api/v1/users/profile/:userId<br/>Authorization: Bearer token<br/>(userId must match token)
    
    Gateway->>CoreNginx: Forward to Core Pod
    CoreNginx->>UserService: DELETE /api/v1/users/profile/:userId
    
    Note over UserService: Security check:<br/>Verify userId in JWT matches<br/>userId in URL param
    
    UserService->>Auth: authenticateToken(token)
    Auth->>Redis: Validate session
    Redis-->>Auth: Session valid
    Auth-->>UserService: ✅ Authenticated<br/>(userId: 123)
    
    alt UserId Mismatch
        Note over UserService: userId from token: 123<br/>userId from URL: 456
        UserService-->>CoreNginx: 403 Forbidden<br/>{error: "Cannot delete another user's profile"}
    else UserId Match - Proceed with Deletion
        
        UserService->>DB: BEGIN TRANSACTION
        
        Note over UserService: Soft delete approach<br/>(keep audit trail)
        
        UserService->>DB: SELECT photo_url FROM profiles<br/>WHERE user_id = 123
        DB-->>UserService: photo_url: "/uploads/avatars/avatar-xxx.jpg"
        
        par Delete All User Data
            UserService->>DB: UPDATE profiles<br/>SET deleted_at = NOW(),<br/>    is_deleted = true<br/>WHERE user_id = 123
            DB-->>UserService: ✅ Profile soft deleted
            
            UserService->>DB: DELETE FROM user_preferences<br/>WHERE user_id = 123
            DB-->>UserService: ✅ Preferences deleted
            
            UserService->>DB: DELETE FROM notification_settings<br/>WHERE user_id = 123
            DB-->>UserService: ✅ Notifications deleted
            
            UserService->>DB: DELETE FROM privacy_settings<br/>WHERE user_id = 123
            DB-->>UserService: ✅ Privacy settings deleted
            
            UserService->>DB: DELETE FROM travel_preferences<br/>WHERE user_id = 123
            DB-->>UserService: ✅ Travel prefs deleted
        end
        
        UserService->>DB: COMMIT TRANSACTION
        
        Note over UserService: Clean up cached data
        
        UserService->>Redis: DEL profile_cache:123
        UserService->>Redis: DEL session:123<br/>(logout user immediately)
        Redis-->>UserService: ✅ Cache & session cleared
        
        Note over UserService: Delete avatar file
        
        UserService->>FileSystem: DELETE /uploads/avatars/avatar-xxx.jpg
        FileSystem-->>UserService: ✅ File deleted
        
        Note over UserService: Notify Auth Service<br/>to invalidate tokens
        
        UserService->>Auth: POST /internal/invalidate-user<br/>{userId: 123}
        Auth->>Redis: DEL all_sessions_for_user:123
        Auth-->>UserService: ✅ All tokens invalidated
        
        Note over UserService: Publish deletion event
        
        UserService->>Kafka: PUBLISH event:<br/>topic: "user.profile.deleted"<br/>{<br/>  userId: 123,<br/>  deletedAt: "2025-12-05T11:00:00Z",<br/>  reason: "USER_REQUEST"<br/>}
        
        UserService-->>CoreNginx: 200 OK<br/>{<br/>  success: true,<br/>  message: "Profile deleted successfully"<br/>}
    end
    
    CoreNginx-->>Gateway: Forward response
    Gateway-->>WebClient: Deletion confirmed
    
    WebClient->>WebClient: Clear all local storage:<br/>- Remove JWT tokens<br/>- Clear Redux state<br/>- Clear cookies
    
    WebClient-->>User: Show "Account Deleted"<br/>Redirect to homepage

    Note over User,DB: **Deletion Time: ~500-800ms**<br/>(Transaction + cache clear + file deletion + event publish)

    rect rgb(255, 240, 240)
        Note over UserService,DB: **GDPR Compliance:**<br/>- Soft delete for audit trail (30 days)<br/>- Hard delete after 30 days (cron job)<br/>- Export user data before deletion
    end